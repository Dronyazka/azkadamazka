<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gamma / Hadamard / Luschny (Pyodide)</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #0f172a;
      color: #e6eef8;
    }
    .wrap {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      box-sizing: border-box;
    }
    .card {
      background: #0b1220;
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(2, 6, 23, 0.6);
      width: 820px;
      max-width: 100%;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    input[type=text] {
      flex: 1;
      padding: 12px 14px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(255, 255, 255, 0.02);
      color: inherit;
      font-size: 16px;
      outline: none;
    }
    input[type=text]:focus {
      border-color: #3b82f6;
    }
    .btn {
      padding: 12px 16px;
      border-radius: 8px;
      border: none;
      background: #2563eb;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.1s;
    }
    .btn:hover {
      background: #1d4ed8;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .toggle {
      min-width: 70px;
    }
    .box {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.02);
    }
    .label {
      font-weight: 700;
      margin-bottom: 8px;
      color: #b0c4de;
    }
    .out {
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      white-space: pre-wrap;
      word-break: break-word;
      background: #1e293b;
      padding: 12px 14px;
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
    }
    .small {
      font-size: 13px;
      color: #94a3b8;
      margin-top: 16px;
      text-align: right;
    }
    .error-box {
      background: #2d1a1a;
      border-left: 3px solid #ef4444;
      color: #fecaca;
      padding: 12px;
      border-radius: 6px;
      font-family: monospace;
      white-space: pre-wrap;
      margin-top: 16px;
      display: none;
    }
    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      .controls .row-btns {
        display: flex;
        gap: 8px;
      }
      .controls .row-btns button {
        flex: 1;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="controls">
      <input type="text" id="xinput" placeholder="e.g. 2.5, -1, 1+2j" aria-label="Argument x" />
      <div class="row-btns">
        <button id="compute" class="btn">Compute</button>
        <button id="toggle" class="btn toggle">+1</button>
      </div>
    </div>

    <div class="box">
      <div id="labelGamma" class="label">Euler gamma function:</div>
      <div id="outGamma" class="out">‚Äî</div>
    </div>
    <div class="box">
      <div id="labelHad" class="label">Hadamard gamma function:</div>
      <div id="outHad" class="out">‚Äî</div>
    </div>
    <div class="box">
      <div id="labelLus" class="label">Luschny factorial (argument shifted by ‚àí1):</div>
      <div id="outLus" class="out">‚Äî</div>
    </div>

    <div id="status" class="small">‚è≥ loading Python ...</div>
    <div id="errorBox" class="error-box"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
<script>
  (function() {
    const computeBtn = document.getElementById('compute');
    const toggleBtn = document.getElementById('toggle');
    const xinput = document.getElementById('xinput');
    const statusDiv = document.getElementById('status');
    const errorBox = document.getElementById('errorBox');

    const outGamma = document.getElementById('outGamma');
    const outHad = document.getElementById('outHad');
    const outLus = document.getElementById('outLus');

    const labelGamma = document.getElementById('labelGamma');
    const labelHad = document.getElementById('labelHad');
    const labelLus = document.getElementById('labelLus');

    let pyodideReady = false;
    let shiftOn = false;       // false = unshifted (toggle shows "+1")

    function showError(msg) {
      errorBox.textContent = msg;
      errorBox.style.display = 'block';
    }
    function clearError() {
      errorBox.textContent = '';
      errorBox.style.display = 'none';
    }

    function updateUILabels() {
      if (shiftOn) {
        toggleBtn.textContent = '‚àí1';
        labelGamma.textContent = 'Euler gamma function (argument shifted by +1):';
        labelHad.textContent = 'Hadamard gamma function (argument shifted by +1):';
        labelLus.textContent = 'Luschny factorial:';
      } else {
        toggleBtn.textContent = '+1';
        labelGamma.textContent = 'Euler gamma function:';
        labelHad.textContent = 'Hadamard gamma function:';
        labelLus.textContent = 'Luschny factorial (argument shifted by ‚àí1):';
      }
    }

    toggleBtn.addEventListener('click', () => {
      shiftOn = !shiftOn;
      updateUILabels();
      if (pyodideReady && xinput.value.trim() !== '') {
        compute();
      }
    });

    async function initPyodide() {
      try {
        computeBtn.disabled = true;
        computeBtn.textContent = 'Loading ‚Ä¶';
        statusDiv.textContent = 'üì¶ loading Pyodide ...';
        window.pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' });

        statusDiv.textContent = 'üì¶ installing mpmath (high precision) ...';
        await pyodide.loadPackage('micropip');
        const micropip = pyodide.pyimport('micropip');
        await micropip.install('mpmath');

        pyodideReady = true;
        computeBtn.disabled = false;
        computeBtn.textContent = 'Compute';
        statusDiv.textContent = '‚úÖ ready ‚Äî enter a value';
        clearError();
      } catch (err) {
        console.error('Pyodide init failed:', err);
        statusDiv.textContent = '‚ùå failed to load Python environment';
        showError(`Initialisation error:\n${err}\n\nPlease check your network or CDN.`);
        computeBtn.disabled = true;
        computeBtn.textContent = 'Error';
      }
    }
    initPyodide();

    computeBtn.addEventListener('click', compute);
    xinput.addEventListener('keydown', (e) => { if (e.key === 'Enter') compute(); });

    async function compute() {
      clearError();
      if (!pyodideReady) {
        statusDiv.textContent = '‚è≥ Python not ready, please wait.';
        return;
      }

      const raw = xinput.value.trim();
      if (raw === '') {
        outGamma.textContent = '‚Äî';
        outHad.textContent = '‚Äî';
        outLus.textContent = '‚Äî';
        statusDiv.textContent = '‚úèÔ∏è enter a number (real or complex)';
        return;
      }

      computeBtn.disabled = true;
      computeBtn.textContent = 'Computing‚Ä¶';
      statusDiv.textContent = '‚öôÔ∏è computing ...';

      try {
        pyodide.globals.set('x_str', raw);
        const shiftInt = shiftOn ? 1 : 0;

        // Python code with per‚Äëfunction exception handling and 250‚Äëdigit precision
        const code = `
from mpmath import mp, gamma, psi, sin, pi, nstr, inf, isinf, isnan, mpc, mpmathify

mp.dps = 250

def format_value(z):
    """return a string with 15 significant digits; poles ‚Üí ‚àûÃÉ"""
    if isinf(z) or isnan(z):
        return "‚àûÃÉ"
    if isinstance(z, mpc):
        re = mp.re(z)
        im = mp.im(z)
        if im == 0:
            return nstr(re, 15)
        re_str = nstr(re, 15)
        im_str = nstr(abs(im), 15)
        sign = '+' if im >= 0 else '-'
        return f"{re_str} {sign} {im_str}j"
    else:
        return nstr(z, 15)

# Parse input
try:
    x = mpmathify(x_str)
except Exception:
    euler = had = lus = "‚ùå invalid input"
else:
    # Helper for safe computation of each function
    def safe_gamma():
        try:
            val = gamma(x) if shift == 0 else gamma(x + 1)
            return format_value(val)
        except Exception:
            return "‚àûÃÉ"

    def safe_hadamard():
        try:
            if shift == 0:
                # Hadamard unshifted
                val = (psi(1 - x/2) - psi((1 - x)/2)) / (2 * gamma(1 - x))
            else:
                # Hadamard shifted (x+1)
                val = (psi(1 - (x+1)/2) - psi((1 - (x+1))/2)) / (2 * gamma(1 - (x+1)))
            return format_value(val)
        except Exception:
            return "‚àûÃÉ"

    def safe_luschny():
        try:
            if shift == 0:
                # Luschny factorial (shift -1 already in formula)
                term_sin = 1 - sin(pi*(x-1)) / (pi*(x-1))
                term_digamma = ((x-1)/2) * (psi(x/2) - psi((x-1)/2)) - 0.5
                val = gamma(x) * term_sin * term_digamma
            else:
                # Luschny shifted (x+1)
                term_sin = 1 - sin(pi*x) / (pi*x)
                term_digamma = (x/2) * (psi((x+1)/2) - psi(x/2)) - 0.5
                val = gamma(x + 1) * term_sin * term_digamma
            return format_value(val)
        except Exception:
            return "‚àûÃÉ"

    euler = safe_gamma()
    had = safe_hadamard()
    lus = safe_luschny()

(euler, had, lus)
        `;

        // Inject shift value into the code (replace the literal 'shift == 0' condition)
        const fullCode = code.replace('if shift == 0', `if shift == ${shiftInt}`)
                             .replace('else:', `else:`);  // else stays as is

        const result = await pyodide.runPythonAsync(fullCode);
        const [gammaStr, hadStr, lusStr] = result.toJs();

        outGamma.textContent = gammaStr;
        outHad.textContent = hadStr;
        outLus.textContent = lusStr;

        statusDiv.textContent = '‚úÖ done';
      } catch (err) {
        console.error(err);
        outGamma.textContent = '‚Äî';
        outHad.textContent = '‚Äî';
        outLus.textContent = '‚Äî';
        statusDiv.textContent = '‚ùå computation error';
        showError(`Python error:\n${err.message || err}`);
      } finally {
        computeBtn.disabled = false;
        computeBtn.textContent = 'Compute';
        try { pyodide.globals.delete('x_str'); } catch(e) {}
      }
    }

    updateUILabels();
  })();
</script>
</body>
</html>
