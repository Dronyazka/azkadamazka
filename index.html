<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pyodide: Gamma / Hadamard / Luschny demo</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 24px; max-width: 900px; margin: auto; color: #111 }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px }
    .controls { display: flex; gap: 8px; }
    input[type="text"] { flex: 1; padding: 10px 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #888; background: #f5f5f5; cursor: pointer }
    button.toggle { min-width: 64px; text-align: center }
    .box { background: #fafafa; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px }
    .label { font-weight: 600; margin-bottom: 6px }
    .out { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Noto Mono", monospace; white-space: pre-wrap; }
    #status { font-size: 13px; color: #666 }
    .small { font-size: 13px; color: #666 }/* Mobile: stack input and buttons vertically */
@media (max-width: 600px) {
  .row { flex-direction: column; align-items: stretch }
  .controls { flex-direction: row; }
  .controls button { flex: 1 }
  button { width: 100% }
}

  </style>
  <!-- Load Pyodide first so loadPyodide is available to the inline script below -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
</head>
<body>
  <h2>Gamma / Hadamard / Luschny calculator (Pyodide)</h2>
  <div class="row">
    <input id="input" type="text" placeholder="Enter a number" aria-label="input value" value="">
    <div class="controls">
      <button id="compute">Compute</button>
      <button id="toggle" class="toggle">+1</button>
    </div>
  </div>
  <div id="status" class="small">Loading Pyodide...</div>  <div class="box">
    <div id="labelGamma" class="label">Euler gamma function:</div>
    <div id="outGamma" class="out">—</div>
  </div>  <div class="box">
    <div id="labelHad" class="label">Hadamard gamma function:</div>
    <div id="outHad" class="out">—</div>
  </div>  <div class="box">
    <div id="labelLus" class="label">Luschny factorial (argument shifted by −1):</div>
    <div id="outLus" class="out">—</div>
  </div>  <script>
    // This page uses Pyodide and mpmath. It loads pyodide from jsdelivr and installs mpmath via micropip.
    let pyodide = null;
    let shiftOn = false; // false = unpressed (+1 shown), true = pressed (−1 shown)

    const statusEl = document.getElementById('status');
    const inputEl  = document.getElementById('input');
    const computeBtn = document.getElementById('compute');
    const toggleBtn = document.getElementById('toggle');

    const outGamma = document.getElementById('outGamma');
    const outHad = document.getElementById('outHad');
    const outLus = document.getElementById('outLus');

    const labelGamma = document.getElementById('labelGamma');
    const labelHad = document.getElementById('labelHad');
    const labelLus = document.getElementById('labelLus');

    // Disable compute until Pyodide is ready
    computeBtn.disabled = true;

    async function initPyodide() {
      try {
        statusEl.textContent = 'Loading Pyodide (this may take a few seconds)...';
        pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' });
        statusEl.textContent = 'Pyodide loaded — installing mpmath...';
        await pyodide.loadPackage('micropip');
        await pyodide.runPythonAsync("import micropip
await micropip.install('mpmath')");
        statusEl.textContent = 'Ready.';
        computeBtn.disabled = false;
      } catch (err) {
        statusEl.textContent = 'Error loading Pyodide: ' + err;
        console.error(err);
      }
    }

    function updateLabels() {
      if (shiftOn) {
        toggleBtn.textContent = '−' + '1'; // unicode minus sign
        labelGamma.textContent = 'Euler gamma function (argument shifted by +1):';
        labelHad.textContent = 'Hadamard gamma function (argument shifted by +1):';
        labelLus.textContent = 'Luschny factorial:';
      } else {
        toggleBtn.textContent = '+1';
        labelGamma.textContent = 'Euler gamma function:';
        labelHad.textContent = 'Hadamard gamma function:';
        labelLus.textContent = 'Luschny factorial (argument shifted by −1):';
      }
    }

    toggleBtn.addEventListener('click', () => {
      shiftOn = !shiftOn;
      updateLabels();
      // recompute when toggled
      compute();
    });

    computeBtn.addEventListener('click', compute);

    async function compute() {
      if (!pyodide) {
        statusEl.textContent = 'Pyodide is not ready yet.';
        return;
      }
      const xStr = inputEl.value.trim();
      if (xStr === '') {
        statusEl.textContent = 'Enter a numeric input first.';
        outGamma.textContent = '—';
        outHad.textContent = '—';
        outLus.textContent = '—';
        return;
      }
      outGamma.textContent = 'computing...';
      outHad.textContent = 'computing...';
      outLus.textContent = 'computing...';

      try {
        // Python snippet. Internal precision: 250 decimal places. Output significand: 15 significant digits.
        const pyCode = `
from mpmath import mp, mpf, gamma, digamma, sin, pi, nstr
mp.mp.dps = 250
x = mpf(${JSON.stringify(xStr)})
s = ${shiftOn ? 'True' : 'False'}

# format: 15 significant digits
def fmt(v):
    try:
        if not mp.isfinite(v):
            return '∞̃'
        return nstr(v, 15)
    except Exception:
        return str(v)

# safe gamma wrapper
def safe_gamma(a):
    try:
        g = gamma(a)
        if not mp.isfinite(g):
            return None
        return g
    except Exception:
        return None

if s:
    # shifted-by-+1 mode
    gamma_val = safe_gamma(x + 1)
    if gamma_val is None:
        gamma_out = '∞̃'
    else:
        gamma_out = fmt(gamma_val)

    # Hadamard: (digamma(1 - (x+1)/2) - digamma((1 - (x+1))/2))/(2 * gamma(1 - (x+1)))
    den = safe_gamma(1 - (x + 1))
    try:
        if den is None:
            had_out = '∞̃'
        else:
            had = (digamma(1 - (x + 1)/2) - digamma((1 - (x + 1))/2)) / (2 * den)
            had_out = fmt(had)
    except Exception:
        had_out = '∞̃'

    # Luschny factorial (not shifted): Gamma(x+1) * (1 - sin(pi*x)/(pi*x)) * (x/2*(digamma((x+1)/2) - digamma(x/2)) - 1/2)
    if x == 0:
        lus_out = fmt(mpf('1'))
    else:
        try:
            if gamma_val is None:
                lus_out = '∞̃'
            else:
                lus = gamma_val * (1 - sin(pi * x) / (pi * x)) * (x/2 * (digamma((x + 1)/2) - digamma(x/2)) - mp.mpf('1')/2)
                lus_out = fmt(lus)
        except Exception:
            lus_out = '∞̃'
else:
    # unshifted mode
    gamma_val = safe_gamma(x)
    if gamma_val is None:
        gamma_out = '∞̃'
    else:
        gamma_out = fmt(gamma_val)

    den = safe_gamma(1 - x)
    try:
        if den is None:
            had_out = '∞̃'
        else:
            had = (digamma(1 - x/2) - digamma((1 - x)/2)) / (2 * den)
            had_out = fmt(had)
    except Exception:
        had_out = '∞̃'

    y = x - 1
    # Luschny factorial (argument shifted by -1)
    if y == 0:
        lus_out = fmt(mpf('1'))
    else:
        try:
            if gamma_val is None:
                lus_out = '∞̃'
            else:
                lus = gamma_val * (1 - sin(pi * y) / (pi * y)) * (y/2 * (digamma((y + 1)/2) - digamma(y/2)) - mp.mpf('1')/2)
                lus_out = fmt(lus)
        except Exception:
            lus_out = '∞̃'

result = {'gamma': gamma_out, 'hadamard': had_out, 'luschny': lus_out}
result
`;

        const pyResult = await pyodide.runPythonAsync(pyCode);
        const jsResult = pyResult.toJs ? pyResult.toJs() : pyResult;

        outGamma.textContent = jsResult.gamma;
        outHad.textContent = jsResult.hadamard;
        outLus.textContent = jsResult.luschny;
        statusEl.textContent = 'Computed.';
      } catch (err) {
        console.error(err);
        outGamma.textContent = 'Error: ' + err;
        outHad.textContent = 'Error: ' + err;
        outLus.textContent = 'Error: ' + err;
        statusEl.textContent = 'Computation failed. See console for details.';
      }
    }

    // Initialize on load
    (async () => {
      await initPyodide();
      updateLabels();
    })();
  </script></body>
</html>
