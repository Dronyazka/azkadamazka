<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pyodide: Gamma / Hadamard / Luschny demo</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 24px; max-width: 900px; margin: auto; color: #111 }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px }
    .controls { display: flex; gap: 8px; }
    input[type="text"] { flex: 1; padding: 10px 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc }
    button { padding: 10px 14px; border-radius: 8px; border: 1px solid #888; background: #f5f5f5; cursor: pointer }
    button.toggle { min-width: 64px; text-align: center }
    .box { background: #fafafa; border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px }
    .label { font-weight: 600; margin-bottom: 6px }
    .out { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Noto Mono", monospace; white-space: pre-wrap; }
    #status { font-size: 13px; color: #666 }
    .small { font-size: 13px; color: #666 }/* Mobile: stack input and buttons vertically */
@media (max-width: 600px) {
  .row { flex-direction: column; align-items: stretch }
  .controls { flex-direction: row; }
  .controls button { flex: 1 }
  button { width: 100% }
}

  </style>
</head>
<body>
  <h2>Gamma / Hadamard / Luschny calculator (Pyodide)</h2>
  <div class="row">
    <input id="input" type="text" placeholder="Enter a number" aria-label="input value" value="">
    <div class="controls">
      <button id="compute">Compute</button>
      <button id="toggle" class="toggle">+1</button>
    </div>
  </div>
  <div id="status" class="small">Initializing…</div>  <div class="box">
    <div id="labelGamma" class="label">Euler gamma function:</div>
    <div id="outGamma" class="out">—</div>
  </div>  <div class="box">
    <div id="labelHad" class="label">Hadamard gamma function:</div>
    <div id="outHad" class="out">—</div>
  </div>  <div class="box">
    <div id="labelLus" class="label">Luschny factorial (argument shifted by −1):</div>
    <div id="outLus" class="out">—</div>
  </div>  <script>
    // Robust Pyodide loader with fallback and clearer ready signalling.
    // This script dynamically loads the pyodide.js script and then calls loadPyodide().

    let pyodide = null;
    let pyodideReady = null; // promise that resolves when pyodide is ready
    let shiftOn = false;

    const statusEl = document.getElementById('status');
    const inputEl  = document.getElementById('input');
    const computeBtn = document.getElementById('compute');
    const toggleBtn = document.getElementById('toggle');

    const outGamma = document.getElementById('outGamma');
    const outHad = document.getElementById('outHad');
    const outLus = document.getElementById('outLus');

    const labelGamma = document.getElementById('labelGamma');
    const labelHad = document.getElementById('labelHad');
    const labelLus = document.getElementById('labelLus');

    computeBtn.disabled = true;

    function updateLabels() {
      if (shiftOn) {
        toggleBtn.textContent = '−' + '1';
        labelGamma.textContent = 'Euler gamma function (argument shifted by +1):';
        labelHad.textContent = 'Hadamard gamma function (argument shifted by +1):';
        labelLus.textContent = 'Luschny factorial:';
      } else {
        toggleBtn.textContent = '+1';
        labelGamma.textContent = 'Euler gamma function:';
        labelHad.textContent = 'Hadamard gamma function:';
        labelLus.textContent = 'Luschny factorial (argument shifted by −1):';
      }
    }

    toggleBtn.addEventListener('click', () => {
      shiftOn = !shiftOn;
      updateLabels();
      // attempt a compute; this will await pyodide if necessary
      compute();
    });

    computeBtn.addEventListener('click', compute);

    // Attempt to load pyodide script from a list of CDNs, sequentially, with per-source timeout.
    function loadScriptWithTimeout(src, timeout = 20000) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load ' + src));
        document.head.appendChild(script);
        // timeout
        const t = setTimeout(() => {
          script.onload = null;
          script.onerror = null;
          reject(new Error('Timed out loading ' + src));
        }, timeout);
      });
    }

    async function initPyodide() {
      const cdns = [
        'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js',
        'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js' // same for now; you can add another CDN mirror if available
      ];

      statusEl.textContent = 'Loading Pyodide script...';

      let scriptLoaded = false;
      let lastErr = null;
      for (const src of cdns) {
        try {
          await loadScriptWithTimeout(src, 25000);
          scriptLoaded = true;
          break;
        } catch (err) {
          console.warn('Script load failed for', src, err);
          lastErr = err;
        }
      }

      if (!scriptLoaded) {
        statusEl.textContent = 'Failed to load Pyodide script: ' + (lastErr && lastErr.message);
        computeBtn.disabled = true;
        return;
      }

      statusEl.textContent = 'Initializing Pyodide runtime...';

      try {
        // indexURL should point to the directory that contains the wasm and packages
        pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' });
        await pyodide.loadPackage('micropip');
        statusEl.textContent = 'Installing mpmath (micropip)...';
        await pyodide.runPythonAsync("import micropip
await micropip.install('mpmath')");
        statusEl.textContent = 'Pyodide ready.';
        computeBtn.disabled = false;
      } catch (err) {
        console.error('Pyodide init failed', err);
        statusEl.textContent = 'Pyodide initialization failed: ' + err;
        computeBtn.disabled = true;
      }
    }

    // Start initialization immediately and expose a promise.
    pyodideReady = initPyodide();

    async function compute() {
      // Wait for pyodideReady to settle, but don't throw if it failed.
      try {
        await pyodideReady;
      } catch (e) {
        // initialization failed earlier
      }

      if (!pyodide) {
        statusEl.textContent = 'Pyodide is not available in this environment.';
        return;
      }

      const xStr = inputEl.value.trim();
      if (xStr === '') {
        statusEl.textContent = 'Enter a numeric input first.';
        outGamma.textContent = '—';
        outHad.textContent = '—';
        outLus.textContent = '—';
        return;
      }

      outGamma.textContent = 'computing...';
      outHad.textContent = 'computing...';
      outLus.textContent = 'computing...';

      // Use a python snippet similar to before, with high precision and formatted output.
      const pyCode = `
from mpmath import mp, mpf, gamma, digamma, sin, pi, nstr
mp.mp.dps = 250
x = mpf(${JSON.stringify(xStr)})
s = ${shiftOn ? 'True' : 'False'}

# format: 15 significant digits
def fmt(v):
    try:
        if not mp.isfinite(v):
            return '∞̃'
        return nstr(v, 15)
    except Exception:
        return str(v)

# safe gamma wrapper
def safe_gamma(a):
    try:
        g = gamma(a)
        if not mp.isfinite(g):
            return None
        return g
    except Exception:
        return None

if s:
    gamma_val = safe_gamma(x + 1)
    gamma_out = '∞̃' if gamma_val is None else fmt(gamma_val)
    den = safe_gamma(1 - (x + 1))
    try:
        had = (digamma(1 - (x + 1)/2) - digamma((1 - (x + 1))/2)) / (2 * den) if den is not None else None
        had_out = '∞̃' if had is None else fmt(had)
    except Exception:
        had_out = '∞̃'
    # Luschny
    if x == 0:
        lus_out = fmt(mpf('1'))
    else:
        try:
            if gamma_val is None:
                lus_out = '∞̃'
            else:
                lus = gamma_val * (1 - sin(pi * x) / (pi * x)) * (x/2 * (digamma((x + 1)/2) - digamma(x/2)) - mp.mpf('1')/2)
                lus_out = fmt(lus)
        except Exception:
            lus_out = '∞̃'
else:
    gamma_val = safe_gamma(x)
    gamma_out = '∞̃' if gamma_val is None else fmt(gamma_val)
    den = safe_gamma(1 - x)
    try:
        had = (digamma(1 - x/2) - digamma((1 - x)/2)) / (2 * den) if den is not None else None
        had_out = '∞̃' if had is None else fmt(had)
    except Exception:
        had_out = '∞̃'
    y = x - 1
    if y == 0:
        lus_out = fmt(mpf('1'))
    else:
        try:
            if gamma_val is None:
                lus_out = '∞̃'
            else:
                lus = gamma_val * (1 - sin(pi * y) / (pi * y)) * (y/2 * (digamma((y + 1)/2) - digamma(y/2)) - mp.mpf('1')/2)
                lus_out = fmt(lus)
        except Exception:
            lus_out = '∞̃'

result = {'gamma': gamma_out, 'hadamard': had_out, 'luschny': lus_out}
result
`;

      try {
        const pyResult = await pyodide.runPythonAsync(pyCode);
        const jsResult = pyResult.toJs ? pyResult.toJs() : pyResult;

        outGamma.textContent = jsResult.gamma;
        outHad.textContent = jsResult.hadamard;
        outLus.textContent = jsResult.luschny;
        statusEl.textContent = 'Computed.';

        // If the pyResult is a proxy, destroy it to avoid memory leaks
        try { pyResult.destroy && pyResult.destroy(); } catch (e) {}
      } catch (err) {
        console.error('Computation error:', err);
        statusEl.textContent = 'Computation failed: ' + err;
        outGamma.textContent = 'Error';
        outHad.textContent = 'Error';
        outLus.textContent = 'Error';
      }
    }

    // Kick off initialization but allow page to finish parsing first
    window.addEventListener('load', () => {
      // small delay to let network queues settle in constrained environments
      setTimeout(() => { pyodideReady; }, 0);
      updateLabels();
    });
  </script></body>
</html>
