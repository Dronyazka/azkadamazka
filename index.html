<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gamma / Hadamard / Luschny (Pyodide)</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#e6eef8;padding:24px}
    .card{background:#0b1220;padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.6);width:820px;max-width:100%}
    .controls{display:flex;gap:8px;align-items:center}
    input[type=text]{flex:1;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);color:inherit;font-size:16px}
    .btn{padding:10px 14px;border-radius:8px;border:none;background:#2563eb;color:white;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toggle{min-width:64px}
    .box{margin-top:12px;padding:12px;border-radius:8px;background:rgba(255,255,255,.02)}
    .label{font-weight:700;margin-bottom:6px}
    .out{font-family:monospace;white-space:pre-wrap}
    .small{font-size:13px;color:rgba(230,238,248,.7);margin-top:8px}
    .error{color:#ffb4b4}
    pre#errorBox{background:#2b3440;padding:10px;border-radius:8px;color:#ffecec;white-space:pre-wrap;overflow:auto;max-height:200px;display:none;margin-top:12px}@media (max-width:600px){
  .controls{flex-direction:column;align-items:stretch}
  .controls .row-btns{display:flex;gap:8px}
  .controls .row-btns button{flex:1}
}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="controls">
        <input id="xinput" type="text" placeholder="Enter a number (real or complex, e.g. 3.5 or 1+2j)" aria-label="x value" />
        <div class="row-btns" style="display:flex;gap:8px">
          <button id="compute" class="btn">Compute</button>
          <button id="toggle" class="btn toggle">+1</button>
        </div>
      </div><div class="box">
    <div id="labelGamma" class="label">Euler gamma function:</div>
    <div id="outGamma" class="out">—</div>
  </div>

  <div class="box">
    <div id="labelHad" class="label">Hadamard gamma function:</div>
    <div id="outHad" class="out">—</div>
  </div>

  <div class="box">
    <div id="labelLus" class="label">Luschny factorial (argument shifted by −1):</div>
    <div id="outLus" class="out">—</div>
  </div>

  <div id="status" class="small">Loading...</div>
  <pre id="errorBox"></pre>
</div>

  </div>  <!-- Load Pyodide -->  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>  <script>
    const computeBtn = document.getElementById('compute');
    const xinput = document.getElementById('xinput');
    const status = document.getElementById('status');

    const outGamma = document.getElementById('outGamma');
    const outHad = document.getElementById('outHad');
    const outLus = document.getElementById('outLus');

    const labelGamma = document.getElementById('labelGamma');
    const labelHad = document.getElementById('labelHad');
    const labelLus = document.getElementById('labelLus');

    const toggleBtn = document.getElementById('toggle');
    const errorBox = document.getElementById('errorBox');

    let pyodideReady = false;
    let shiftOn = false; // false => unshifted (toggle shows +1)

    function showError(text){
      errorBox.textContent = text;
      errorBox.style.display = 'block';
    }
    function clearError(){
      errorBox.textContent = '';
      errorBox.style.display = 'none';
    }

    function updateLabels(){
      if(shiftOn){
        toggleBtn.textContent = '−' + '1';
        labelGamma.textContent = 'Euler gamma function (argument shifted by +1):';
        labelHad.textContent = 'Hadamard gamma function (argument shifted by +1):';
        labelLus.textContent = 'Luschny factorial:';
      } else {
        toggleBtn.textContent = '+1';
        labelGamma.textContent = 'Euler gamma function:';
        labelHad.textContent = 'Hadamard gamma function:';
        labelLus.textContent = 'Luschny factorial (argument shifted by −1):';
      }
    }

    toggleBtn.addEventListener('click', ()=>{
      shiftOn = !shiftOn;
      updateLabels();
      // recompute after toggle (only if python ready)
      if(pyodideReady) compute();
    });

    async function initPyodide(){
      try{
        computeBtn.disabled = true;
        computeBtn.textContent = 'Loading Python…';
        status.textContent = 'Loading Pyodide...';
        window.pyodide = await loadPyodide({indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/'});
        status.textContent = 'Installing mpmath...';
        await pyodide.loadPackage('micropip');
        await pyodide.runPythonAsync(`import micropip
await micropip.install('mpmath')`);
        pyodideReady = true;
        computeBtn.disabled = false;
        computeBtn.textContent = 'Compute';
        status.textContent = 'Ready';
      } catch(err){
        console.error('Pyodide init error', err);
        status.textContent = 'Failed to load Python or packages. See error details below.';
        showError(String(err) + '

Hint: network or CDN may be blocked.');
        computeBtn.disabled = true;
        computeBtn.textContent = 'Error';
      }
    }

    initPyodide();

    computeBtn.addEventListener('click', compute);
    xinput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') compute(); });

    async function compute(){
      clearError();
      if(!pyodideReady){
        status.textContent = 'Python not ready';
        return;
      }
      const raw = xinput.value.trim();
      if(raw === ''){
        status.textContent = 'Enter a numeric input first.';
        outGamma.textContent = '—';
        outHad.textContent = '—';
        outLus.textContent = '—';
        return;
      }

      computeBtn.disabled = true;
      computeBtn.textContent = 'Computing…';
      status.textContent = 'Computing...';

      const code = `
# Adapted compute routine taken from the working 'Factorial family' example
from mpmath import mp, mpf, mpc, sin, pi, nstr, gamma, digamma
import traceback
mp.mp.dps = 250

# robust string formatting helpers (adapted)
def format_complex(z, integer_input=False, keep_imag=False):
    try:
        if mp.isinf(z) or abs(z) > mp.mpf('1e300'):
            return '∞̃'
        re = mp.re(z)
        im = mp.im(z)
        if integer_input and not keep_imag:
            im = mp.mpf('0')
        re_s = nstr(re, 40)
        im_s = nstr(im, 40)
        def norm(s):
            if 'e' in s or 'E' in s:
                return s
            if '.' in s:
                s = s.rstrip('0').rstrip('.')
                if s == '-0':
                    return '0'
            return s
        re_s = norm(re_s)
        im_abs_s = norm(im_s.lstrip('-'))
        if mp.sign(im) == 0:
            return re_s
        if mp.sign(re) == 0:
            sign = '-' if mp.sign(im) < 0 else ''
            return f"{sign}{im_abs_s}i"
        sign = ' + ' if mp.sign(im) >= 0 else ' - '
        return f"{re_s}{sign}{im_abs_s}i"
    except Exception:
        return 'Error'

def approximate_if_needed(s):
    try:
        if 'i' in s or s=='∞̃':
            return s
        num = mp.mpf(s)
        if num == 0:
            return '0'
        if (mp.mpf('1e-10') < abs(num) < mp.mpf('1e30')):
            fixed = nstr(num, 40)
            if 'e' in fixed or 'E' in fixed:
                with mp.workdps(40):
                    fixed = nstr(num, 40)
            if '.' in fixed:
                fixed = fixed.rstrip('0').rstrip('.')
            if fixed in ('-0', '+0'):
                return '0'
            return fixed
        else:
            sci = nstr(num, 30, min_fixed=0)
            return f'approximately {sci}'
    except Exception:
        return s

# parse input allowing complex numbers
try:
    x = mpc(${JSON.stringify(raw)})
except Exception as e:
    result = {'error': 'Invalid input: ' + str(e) + '
' + traceback.format_exc()}
else:
    try:
        is_integer_input = (mp.im(x) == 0 and mp.re(x) == int(mp.re(x)))
        s = ${shiftOn ? 'True' : 'False'}

        if s:
            # shifted-by-+1 mode
            g = None
            try:
                g = gamma(x + 1)
            except Exception:
                g = None
            gamma_out = '∞̃' if g is None or not mp.isfinite(g) else approximate_if_needed(format_complex(g, integer_input=False))

            den = None
            try:
                den = gamma(1 - (x + 1))
            except Exception:
                den = None
            try:
                if den is None or not mp.isfinite(den):
                    had_out = '∞̃'
                else:
                    had = (digamma(1 - (x + 1)/2) - digamma((1 - (x + 1))/2)) / (2 * den)
                    had_out = approximate_if_needed(format_complex(had))
            except Exception:
                had_out = '∞̃'

            # Luschny for shifted-on (+1) (no -1 shift)
            try:
                if mp.almosteq(x, 0):
                    lus_out = '1'
                else:
                    if g is None or not mp.isfinite(g):
                        lus_out = '∞̃'
                    else:
                        lusval = g * (1 - sin(pi * x) / (pi * x)) * (x/2 * (digamma((x + 1)/2) - digamma(x/2)) - mp.mpf('1')/2)
                        lus_out = approximate_if_needed(format_complex(lusval))
            except Exception:
                lus_out = '∞̃'
        else:
            # unshifted mode
            g = None
            try:
                g = gamma(x)
            except Exception:
                g = None
            gamma_out = '∞̃' if g is None or not mp.isfinite(g) else approximate_if_needed(format_complex(g, integer_input=False))

            den = None
            try:
                den = gamma(1 - x)
            except Exception:
                den = None
            try:
                if den is None or not mp.isfinite(den):
                    had_out = '∞̃'
                else:
                    had = (digamma(1 - x/2) - digamma((1 - x)/2)) / (2 * den)
                    had_out = approximate_if_needed(format_complex(had))
            except Exception:
                had_out = '∞̃'

            y = x - 1
            try:
                if mp.almosteq(y, 0):
                    lus_out = '1'
                else:
                    if g is None or not mp.isfinite(g):
                        lus_out = '∞̃'
                    else:
                        lusval = g * (1 - sin(pi * y) / (pi * y)) * (y/2 * (digamma((y + 1)/2) - digamma(y/2)) - mp.mpf('1')/2)
                        lus_out = approximate_if_needed(format_complex(lusval))
            except Exception:
                lus_out = '∞̃'

        result = {'gamma': gamma_out, 'hadamard': had_out, 'luschny': lus_out}
    except Exception as e:
        result = {'error': 'Computation failed: ' + str(e) + '
' + traceback.format_exc()}

result
`;

      try{
        const pyResult = await pyodide.runPythonAsync(code);
        // pyResult should be a dict-like PyProxy; convert to JS object
        const jsResult = pyResult.toJs ? pyResult.toJs() : pyResult;

        if(jsResult.error){
          status.textContent = 'Error during computation (see details below)';
          showError(jsResult.error);
          outGamma.textContent = 'Error';
          outHad.textContent = 'Error';
          outLus.textContent = 'Error';
        } else {
          outGamma.textContent = jsResult.gamma;
          outHad.textContent = jsResult.hadamard;
          outLus.textContent = jsResult.luschny;
          status.textContent = 'Done';
        }

        try { pyResult.destroy && pyResult.destroy(); } catch(e){}
      } catch(err){
        // If runPythonAsync itself throws (e.g. Pyodide internal error), surface it to the page for troubleshooting
        console.error('Computation error', err);
        status.textContent = 'Error during computation (see details below)';
        let text = String(err);
        if(err && err.message) text += '
' + err.message;
        if(err && err.stack) text += '
' + err.stack;
        text += '

If this repeats, your environment may be blocking Pyodide resources.';
        showError(text);
        outGamma.textContent = 'Error';
        outHad.textContent = 'Error';
        outLus.textContent = 'Error';
      } finally{
        computeBtn.disabled = false;
        computeBtn.textContent = 'Compute';
      }
    }
  </script></body>
</html>
